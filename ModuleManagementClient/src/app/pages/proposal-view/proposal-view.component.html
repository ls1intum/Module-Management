<app-layout>
  @if (loading) {
  <div class="text-center">Loading...</div>
  } @else if (error) {
  <div class="text-center text-red-500">{{ error }}</div>
  } @else if (proposal) {
  <!-- Header Info -->
  <div class="mb-6 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-3xl font-bold">Module Proposal</h2>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <p class="text-sm text-muted-foreground">Proposal ID</p>
        <p class="text-lg font-medium">{{ proposal.proposalId }}</p>
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Latest Version</p>
        <p class="text-lg font-medium">{{ proposal.latestVersion }}</p>
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Proposal Status</p>
        <div hlmBadge [class]="(proposal.status! | statusDisplay).colorClass">
          {{ (proposal.status! | statusDisplay).text }}
        </div>
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Created On</p>
        <p class="text-lg font-medium">{{ proposal.creationDate | date : 'yyyy-MM-dd' }}</p>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex justify-between mb-10 mt-20">
    <button hlmBtn variant="outline" (click)="addNewModuleVersion()">Create New Version</button>
    <!-- <button hlmBtn variant="destructive" (click)="deleteProposal()">Delete Proposal</button> -->
    @if (proposal.status === proposalStatusEnum.PendingSubmission) { @if (proposal.latestModuleVersion?.isComplete) {
    <button hlmBtn variant="default" class="bg-green-600" (click)="submitProposal()">Submit</button>
    } @else {
    <button hlmBtn variant="default" class="mr-2" (click)="editLatestModuleVersion()">Complete Proposal</button>
    } }
  </div>
  <!-- Latest Version Table -->
  <h2 class="text-xl mb-8">Current Module Versions</h2>
  <hlm-table class="w-full min-w-[400px] mb-8">
    <hlm-caption>Latest Module Version</hlm-caption>
    <hlm-trow>
      <hlm-th class="w-40">Version</hlm-th>
      <hlm-th class="flex-1">Title</hlm-th>
      <hlm-th class="w-50">Status</hlm-th>
      <hlm-th class="w-80">Actions</hlm-th>
    </hlm-trow>

    <hlm-trow>
      <hlm-td truncate class="font-medium w-40">{{ proposal.latestVersion }}</hlm-td>
      <hlm-td class="flex-1">
        <button hlmBtn variant="link" class="text-left px-0" [routerLink]="['/proposals/edit', proposal.proposalId]">
          {{ proposal.latestModuleVersion!.titleEng }}
        </button>
      </hlm-td>
      <hlm-td class="w-50">
        <div hlmBadge [class]="(proposal.latestModuleVersion!.status! | moduleVersionStatus).colorClass">
          {{ (proposal.latestModuleVersion!.status! | moduleVersionStatus).text }}
        </div>
      </hlm-td>
      <hlm-td class="w-80">
        <!-- <button hlmBtn variant="ghost" class="mr-2" (click)="viewModuleVersion(proposal.latestVersion)">View</button> -->
        <button hlmBtn variant="outline" class="mr-2" (click)="editLatestModuleVersion()">Edit</button>
        <!-- <button hlmBtn variant="outline" (click)="addNewModuleVersion()">Add Version</button> -->
      </hlm-td>
    </hlm-trow>
  </hlm-table>

  <!-- Historical Versions Table -->
  <h2 class="text-xl mb-8 text-muted-foreground">Previous Module Versions</h2>
  @if (proposal.oldModuleVersions && proposal.oldModuleVersions.length > 0) {
  <hlm-table class="w-full min-w-[400px] text-muted-foreground">
    <hlm-caption>Historical Module Versions</hlm-caption>
    <hlm-trow>
      <hlm-th class="w-40">Version</hlm-th>
      <hlm-th class="flex-1">Title</hlm-th>
      <hlm-th class="w-50">Status</hlm-th>
      <hlm-th class="w-80">Actions</hlm-th>
    </hlm-trow>

    @for (version of proposal.oldModuleVersions; track version.moduleVersionId) {
    <hlm-trow>
      <hlm-td truncate class="font-medium w-40">{{ version.moduleVersionId }}</hlm-td>
      <hlm-td class="flex-1">
        <button hlmBtn variant="link" class="text-left text-muted-foreground px-0" [routerLink]="['/proposals/view', proposal.proposalId]">
          {{ version.titleEng }}
        </button>
      </hlm-td>
      <hlm-td class="w-50">
        <!-- Todo: Make faded status -->
        <div hlmBadge [class]="(version.status! | fadedModuleVersionStatus).colorClass">
          {{ (version.status! | fadedModuleVersionStatus).text }}
        </div>
      </hlm-td>
      <hlm-td class="w-80">
        <button hlmBtn variant="ghost" (click)="viewModuleVersion(version.moduleVersionId)">View</button>
      </hlm-td>
    </hlm-trow>
    }
  </hlm-table>
  } } @else {
  <div class="text-center">No proposal found</div>
  }
</app-layout>

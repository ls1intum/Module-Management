@if (loading()) {
  <div class="fixed inset-0 flex justify-center items-center">
    <p-progress-spinner ariaLabel="loading" />
  </div>
} @else if (error()) {
  <p-message severity="error" class="mt-8">
    <div class="flex flex-row">
      <i class="pi pi-exclamation-circle" style="font-size: 1.2rem"></i>
      <div class="ml-3">
        <p>{{ error() }}</p>
      </div>
    </div>
  </p-message>
} @else if (moduleVersionDto(); as moduleVersionDto) {
  <div class="max-w-4xl mx-auto space-y-6">
    <h2 class="text-2xl">Overview of '{{ moduleVersionDto.titleEng }}' - Version {{ moduleVersionDto.version }}</h2>
    <div class="flex justify-between mb-6">
      <p-button label="Export PDF" severity="contrast" (onClick)="pdfExport()" />
      <div class="flex gap-2">
        @if (proposalId) {
          <p-button label="Check Overlaps" severity="contrast" outlined [routerLink]="['/proposals/view', proposalId, 'version', moduleVersionId, 'overlap']" />
        }
        @if (isLatestVersion() && moduleVersionDto.status == moduleVersionStatus.PendingSubmission && proposalId) {
          <p-button label="Edit Module Version" severity="contrast" [routerLink]="['/proposals/view', proposalId, 'version', moduleVersionId, 'edit']" />
        }
      </div>
    </div>

    <div class="grid grid-cols-4 gap-4 mb-6">
      <div>
        <p class="text-sm text-muted-foreground">Module Version ID</p>
        <p class="text-lg font-medium">{{ moduleVersionDto.moduleVersionId }}</p>
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Version</p>
        <p class="text-lg font-medium">{{ moduleVersionDto.version }} / {{ moduleVersionDto.latestVersion }}</p>
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Status</p>
        <p-tag [value]="(moduleVersionDto.status! | moduleVersionStatus).text" [severity]="(moduleVersionDto.status! | moduleVersionStatus).severity" />
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Created On</p>
        <p class="text-lg font-medium">{{ moduleVersionDto.creationDate | date: 'yyyy-MM-dd' }}</p>
      </div>
    </div>

    <p-card header="Feedbacks">
      @if (moduleVersionDto.feedbacks?.length) {
        <div class="space-y-6">
          @for (feedback of moduleVersionDto.feedbacks; track feedback.feedbackId) {
            <p-panel class="mb-4" [header]="(feedback.feedbackRole! | feedbackDepartment).text">
              <p-tag [value]="(feedback.feedbackStatus! | feedbackStatus).text" [severity]="(feedback.feedbackStatus! | feedbackStatus).severity" />
              <div class="flex justify-between">
                <p class="font-medium mt-1">{{ feedback.feedbackFromFirstName }} {{ feedback.feedbackFromLastName }}</p>
                <p class="text-sm text-muted-foreground">
                  {{ feedback.submissionDate | date: 'yyyy-MM-dd' }}
                </p>
              </div>

              @if (feedback.rejectionComment) {
                <p-message severity="error" class="mt-4">
                  <p class="font-medium">Rejection Comment:</p>
                  <p class="mt-1 text-muted-foreground">{{ feedback.rejectionComment }}</p>
                </p-message>
              }

              <div class="mt-4 space-y-3">
                @for (field of getFeedbackFields(feedback); track field.key) {
                  <p-message>
                    <p class="font-medium">{{ field.label }}</p>
                    <p class="mt-1 text-muted-foreground">{{ field.value }}</p>
                  </p-message>
                }
              </div>
            </p-panel>
          }
        </div>
      } @else {
        <p class="text-muted-foreground">No feedback provided yet</p>
      }
    </p-card>

    <section class="space-y-4">
      <h3 class="text-xl font-semibold">Module Version Data</h3>
      <div class="grid grid-cols-2 gap-4">
        @for (field of getFieldsBySection('basic'); track field.key) {
          <p-card [header]="field.label">
            <p class="text-base">
              @if (getModuleVersionProperty(field.key)) {
                {{ getModuleVersionProperty(field.key) }}
              } @else {
                <span class="text-muted-foreground italic">Not specified</span>
              }
            </p>
            @if (getFieldFeedbacks(field.key).length > 0) {
              <div class="mt-3 space-y-2">
                @for (feedback of getFieldFeedbacks(field.key); track feedback.feedbackId) {
                  <p-message>
                    <p class="text-sm font-medium">{{ (feedback.feedbackRole! | feedbackDepartment).text }}</p>
                    <p class="text-sm text-muted-foreground mt-1">{{ getFeedbackContent(feedback, field.key) }}</p>
                  </p-message>
                }
              </div>
            }
          </p-card>
        }
      </div>
    </section>

    <section class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        @for (field of getFieldsBySection('hours'); track field.key) {
          <p-card [header]="field.label">
            <p class="text-base">
              @if (getModuleVersionProperty(field.key)) {
                {{ getModuleVersionProperty(field.key) }}
              } @else {
                <span class="text-muted-foreground italic">Not specified</span>
              }
            </p>
            @if (getFieldFeedbacks(field.key).length > 0) {
              <div class="mt-3 space-y-2">
                @for (feedback of getFieldFeedbacks(field.key); track feedback.feedbackId) {
                  <p-message>
                    <p class="text-sm font-medium">{{ (feedback.feedbackRole! | feedbackDepartment).text }}</p>
                    <p class="text-sm text-muted-foreground mt-1">{{ getFeedbackContent(feedback, field.key) }}</p>
                  </p-message>
                }
              </div>
            }
          </p-card>
        }
      </div>
    </section>

    @for (field of getFieldsBySection('content'); track field.key) {
      <p-card [header]="field.label">
        @if (getModuleVersionProperty(field.key)) {
          <p class="text-base whitespace-pre-line">{{ getModuleVersionProperty(field.key) }}</p>
          @if (field.hasPrompt && getModuleVersionProperty(field.hasPrompt)) {
            <p-panel class="mt-4" header="Generation Prompt:">
              <p class="text-base italic">{{ getModuleVersionProperty(field.hasPrompt) }}</p>
            </p-panel>
          }
          @if (getFieldFeedbacks(field.key).length > 0) {
            <div class="mt-3 space-y-2">
              @for (feedback of getFieldFeedbacks(field.key); track feedback.feedbackId) {
                <p-message>
                  <p class="font-medium">{{ (feedback.feedbackRole! | feedbackDepartment).text }}</p>
                  <p class="text-muted-foreground mt-1">{{ getFeedbackContent(feedback, field.key) }}</p>
                </p-message>
              }
            </div>
          }
        } @else {
          <p class="text-muted-foreground italic">No content provided</p>
        }
      </p-card>
    }
  </div>
} @else {
  <div class="text-center py-4">No module version found</div>
}

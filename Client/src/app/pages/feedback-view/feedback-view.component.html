@if (loading) {
  <div class="fixed inset-0 flex justify-center items-center">
    <p-progress-spinner ariaLabel="loading" />
  </div>
} @else if (error) {
  <p-message severity="error" class="mt-8">
    <div class="flex flex-row">
      <i class="pi pi-info-circle" style="font-size: 1.2rem"></i>
      <div class="ml-3">
        <p>{{ error }}</p>
      </div>
    </div>
  </p-message>
} @else if (moduleVersion) {
  <div class="max-w-6xl mx-auto">
    <h2 class="text-2xl mb-6">Module Proposal for '{{ moduleVersion.titleEng }}'</h2>

    <div class="flex justify-end mb-6 gap-4">
      <p-button label="Check Overlaps" severity="contrast" [routerLink]="['/feedbacks/view', feedbackId, 'overlap', moduleVersion.moduleVersionId]" />
      <p-button label="Export PDF" severity="contrast" (onClick)="pdfExport()" />
    </div>

    <!-- main content grid -->
    <div>
      @for (field of moduleFields; track field.key) {
        <div class="py-4">
          <div class="grid grid-cols-8">
            <!-- lhs -->
            <div class="col-span-7">
              <p class="font-medium text-xl mb-2">{{ field.label }}</p>
              <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 whitespace-pre-line">
                {{ getModuleVersionProperty(field.key) || 'Not specified' }}
              </div>
            </div>

            <!-- rhs -->
            <div class="flex justify-end items-end gap-2">
              <p-button
                [icon]="'pi pi-check'"
                [text]="!fieldStates[field.key].accepted"
                (onClick)="handleApprove(field.key)"
                pTooltip="Approve"
                tooltipPosition="top"
                severity="success"
              />
              <p-button
                [icon]="'pi pi-times'"
                [text]="!(fieldStates[field.key].accepted === false)"
                (onClick)="handleReject(field.key)"
                pTooltip="Reject"
                tooltipPosition="top"
                severity="danger"
              />
            </div>
          </div>

          <!-- Feedback section -->
          @if (fieldStates[field.key].accepted === false) {
            <div class="mt-4">
              <label [for]="'feedback-' + field.key" class="sr-only">Feedback for {{ field.label }}</label>
              <textarea
                pTextarea
                [id]="'feedback-' + field.key"
                [name]="'feedback-' + field.key"
                [ngModel]="fieldFeedback[field.key]"
                (ngModelChange)="updateFeedback(field.key, $event)"
                placeholder="Required feedback for rejection..."
                rows="3"
                fluid
                [autoResize]="true"
              ></textarea>
            </div>
          }
        </div>
      }
    </div>

    <!-- form controls -->
    <div class="flex justify-between mt-10">
      <p-button label="Reject" severity="danger" (onClick)="showRejectDialog = true" />
      <p-button label="Submit Feedback" severity="contrast" (onClick)="giveFeedback()" [disabled]="!isEveryFieldFilled()" />
    </div>

    <!-- Reject Dialog -->
    <p-dialog [(visible)]="showRejectDialog" [modal]="true" [style]="{ width: '500px' }" header="Confirm Rejection?">
      <p>
        <span class="font-bold text-red-600">Rejection is final.</span>
        The user cannot make any modifications to this proposal again. Are you sure you want to reject this proposal?
      </p>
      <div class="py-4">
        <label for="rejection-reason" class="sr-only">Rejection reason</label>
        <textarea
          pTextarea
          id="rejection-reason"
          name="rejection-reason"
          [(ngModel)]="rejectionReason"
          placeholder="Enter rejection reason..."
          rows="4"
          fluid
          [autoResize]="true"
        ></textarea>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="showRejectDialog = false" />
        <p-button label="Confirm Rejection" severity="danger" [disabled]="!rejectionReason.trim()" (onClick)="reject()" />
      </ng-template>
    </p-dialog>
  </div>
}
